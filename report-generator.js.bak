// Report Generator
// Generates financial analysis reports and exports to PDF

let currentReportData = null;

// Update report dropdowns
function updateReportDropdowns() {
  const filaments = getFilaments();
  const products = getProducts();

  // Update filament dropdown
  const filamentSelect = document.getElementById('report-filament');
  filamentSelect.innerHTML = '<option value="">Choose filament...</option>' +
    filaments.map(f => `
      <option value="${f.id}">${f.material} - ${f.color} (${f.spoolSize}g @ R${f.price})</option>
    `).join('');

  // Update product dropdown
  const productSelect = document.getElementById('report-product');
  productSelect.innerHTML = '<option value="">Choose product...</option>' +
    products.map(p => `
      <option value="${p.id}">${p.name} (${p.filamentUsed}g, ${p.printTime}h)</option>
    `).join('');
}

// Generate report
function generateReport(event) {
  event.preventDefault();

  const form = event.target;
  const formData = new FormData(form);

  const filamentId = formData.get('filament');
  const productId = formData.get('product');
  const monthlySpools = parseInt(formData.get('monthlySpools'));

  const filaments = getFilaments();
  const products = getProducts();

  const filament = filaments.find(f => f.id === filamentId);
  const product = products.find(p => p.id === productId);

  if (!filament || !product) {
    alert('Please select both filament and product');
    return;
  }

  // Calculate all data
  const baseCosts = calculateCosts(product, filament);
  const scenarios = calculateScenarios(product, filament);
  const production = calculateProduction(product, filament, monthlySpools);

  currentReportData = {
    id: generateId(),
    filament,
    product,
    monthlySpools,
    baseCosts,
    scenarios,
    production,
    generatedDate: new Date().toLocaleDateString()
  };

  // Render report
  renderReport();

  // Show report output
  document.getElementById('report-output').classList.remove('hidden');
  document.getElementById('report-output').scrollIntoView({ behavior: 'smooth' });
}

// Render report HTML
function renderReport() {
  const { filament, product, baseCosts, scenarios, production } = currentReportData;

  const content = `
    <div style="padding: 1rem;">
      <h2 style="text-align: center; margin-bottom: 2rem;">3D PRINTING SPEC REPORT</h2>
      
      <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 2rem;">
        <p><strong>PRODUCT:</strong> ${product.name}</p>
        <p><strong>FILAMENT:</strong> ${filament.material} ${filament.color}, ${filament.spoolSize}g, R${filament.price}/spool</p>
        <p><strong>GENERATED:</strong> ${currentReportData.generatedDate}</p>
      </div>
      
      <h3>A. PRODUCTION SPECS</h3>
      <table class="table">
        <tr><td>Filament Used:</td><td><strong>${product.filamentUsed}g</strong> (${((product.filamentUsed / filament.spoolSize) * 100).toFixed(1)}% of spool)</td></tr>
        <tr><td>Print Time:</td><td><strong>${product.printTime}h</strong></td></tr>
        <tr><td>Layer Height:</td><td>${product.layerHeight}mm</td></tr>
        <tr><td>Infill:</td><td>${product.infill}%</td></tr>
        <tr><td>Support Required:</td><td>${product.supportRequired}</td></tr>
      </table>
      
      <h3 style="margin-top: 2rem;">B. COST BREAKDOWN (Per Unit)</h3>
      <table class="table">
        <tr><td>Material (${filament.material}):</td><td>R${baseCosts.materialCost.toFixed(2)}</td></tr>
        <tr><td>Energy:</td><td>R${product.energyCost.toFixed(2)}</td></tr>
        <tr><td>Labor:</td><td>R${product.laborCost.toFixed(2)}</td></tr>
        <tr><td>Packaging:</td><td>R${product.packagingCost.toFixed(2)}</td></tr>
        <tr><td>Shipping (est.):</td><td>R${product.shippingCost.toFixed(2)}</td></tr>
        <tr style="border-top: 2px solid var(--accent-primary);"><td><strong>TOTAL PRODUCTION COST:</strong></td><td><strong>R${baseCosts.totalCost.toFixed(2)}</strong></td></tr>
      </table>
      
      <h3 style="margin-top: 2rem;">C. PRICING SCENARIOS & MARGINS</h3>
      ${scenarios.map((s, i) => `
        <div style="background: ${i === 1 ? 'rgba(139, 92, 246, 0.1)' : 'var(--bg-tertiary)'}; padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem; ${i === 1 ? 'border: 2px solid var(--accent-primary);' : ''}">
          <h4>${s.name} ${i === 1 ? '← RECOMMENDED' : ''} (R${s.price})</h4>
          <table style="width: 100%; font-size: 0.9rem;">
            <tr><td>Selling Price:</td><td><strong>R${s.price.toFixed(2)}</strong></td></tr>
            <tr><td>Gross Profit:</td><td>R${s.grossProfit.toFixed(2)} | Margin: ${s.grossMarginPercent.toFixed(1)}%</td></tr>
            <tr><td>Net Profit:</td><td><strong style="color: var(--success);">R${s.netProfit.toFixed(2)}</strong> | Margin: <strong style="color: var(--success);">${s.netMarginPercent.toFixed(1)}%</strong></td></tr>
            <tr><td>Per Spool (${s.unitsPerSpool} units):</td><td>R${(s.unitsPerSpool * s.price).toFixed(2)} | Profit: R${s.spoolNetProfit.toFixed(2)}</td></tr>
          </table>
        </div>
      `).join('')}
      
      <h3 style="margin-top: 2rem;">D. PRODUCTION CAPACITY & REVENUE</h3>
      
      <h4>Per 1kg Spool:</h4>
      <table class="table">
        <tr><td>Complete Units:</td><td><strong>${production.perSpool.units} ${product.name.toLowerCase()}s</strong></td></tr>
        <tr><td>Print Time:</td><td>${production.perSpool.printTime} hours</td></tr>
        <tr><td>Material Used:</td><td>${production.perSpool.materialUsed}g (${((production.perSpool.materialUsed / filament.spoolSize) * 100).toFixed(1)}% efficiency)</td></tr>
        <tr><td>Waste/Scrap:</td><td>${production.perSpool.waste.toFixed(0)}g (${((production.perSpool.waste / filament.spoolSize) * 100).toFixed(1)}%)</td></tr>
        <tr><td>Spool Cost:</td><td>R${production.perSpool.spoolCost.toFixed(2)}</td></tr>
        <tr><td>Revenue @ R${product.targetPrice}:</td><td><strong>R${production.perSpool.revenue.toFixed(2)}</strong></td></tr>
        <tr><td>Net Profit:</td><td><strong style="color: var(--success);">R${production.perSpool.netProfit.toFixed(2)}</strong></td></tr>
      </table>
      
      <h4 style="margin-top: 1.5rem;">Monthly (at ${production.monthly.spools} spools/month):</h4>
      <table class="table">
        <tr><td>Units Produced:</td><td><strong>${production.monthly.units} ${product.name.toLowerCase()}s</strong></td></tr>
        <tr><td>Revenue @ R${product.targetPrice}:</td><td><strong>R${production.monthly.revenue.toFixed(2)}</strong></td></tr>
        <tr><td>Material Cost:</td><td>R${production.monthly.materialCost.toFixed(2)}</td></tr>
        <tr><td>Gross Profit:</td><td>R${production.monthly.grossProfit.toFixed(2)} | Margin: ${production.monthly.grossMarginPercent.toFixed(1)}%</td></tr>
        <tr><td>Net Profit (est.):</td><td><strong style="color: var(--success);">R${production.monthly.netProfit.toFixed(2)}</strong> | Margin: <strong style="color: var(--success);">${production.monthly.netMarginPercent.toFixed(1)}%</strong></td></tr>
      </table>
      
      <h4 style="margin-top: 1.5rem;">Annual (conservative ${production.monthly.spools} spools/month):</h4>
      <table class="table">
        <tr><td>Units Produced:</td><td><strong>${production.annual.units} ${product.name.toLowerCase()}s</strong></td></tr>
        <tr><td>Revenue @ R${product.targetPrice}:</td><td><strong>R${production.annual.revenue.toFixed(2)}</strong></td></tr>
        <tr><td>Material Cost:</td><td>R${production.annual.materialCost.toFixed(2)}</td></tr>
        <tr><td>Gross Profit:</td><td>R${production.annual.grossProfit.toFixed(2)} | Margin: ${production.annual.grossMarginPercent.toFixed(1)}%</td></tr>
        <tr><td>Net Profit (est.):</td><td><strong style="color: var(--success);">R${production.annual.netProfit.toFixed(2)}</strong> | Margin: <strong style="color: var(--success);">${production.annual.netMarginPercent.toFixed(1)}%</strong></td></tr>
      </table>
      
      <h3 style="margin-top: 2rem;">E. STRATEGIC RECOMMENDATIONS</h3>
      <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md);">
        <p>✓ <strong>Recommended Selling Price:</strong> R${scenarios[1].price}–${scenarios[2].price}</p>
        <p>✓ <strong>Primary Channel:</strong> Etsy + Personal website</p>
        <p>✓ <strong>Scaling Strategy:</strong> Add 1 printer per ${production.perSpool.units * 10} units/month demand</p>
        <p>✓ <strong>Design Differentiation:</strong> Customize (monograms, logos, colors)</p>
        <p>✓ <strong>Competitive Advantages:</strong> ${baseCosts.grossMarginPercent.toFixed(0)}% gross margins, local production, fast turnaround</p>
      </div>
      
      ${product.notes ? `
      <h3 style="margin-top: 2rem;">F. PRODUCT NOTES</h3>
      <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md);">
        <p>${product.notes}</p>
      </div>
      ` : ''}
    </div>
  `;

  document.getElementById('report-content').innerHTML = content;
}

// Export to PDF
function exportToPDF() {
  if (!currentReportData) {
    alert('Please generate a report first');
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const { filament, product, baseCosts, scenarios, production } = currentReportData;

  let y = 20;
  const lineHeight = 6;
  const pageHeight = doc.internal.pageSize.height;
  const pageWidth = doc.internal.pageSize.width;
  const margin = 20;
  const maxPages = 5;
  let currentPage = 1;

  // Helper function to check if we need a new page
  const checkPageBreak = (neededSpace = 10) => {
    if (y > pageHeight - 30) {
      if (currentPage >= maxPages) {
        return false; // Don't add more pages
      }
      doc.addPage();
      currentPage++;
      y = 20;
    }
    return true;
  };

  // Helper function to add text with page break
  const addText = (text, x, fontSize = 10, style = 'normal') => {
    if (!checkPageBreak()) return false;
    doc.setFontSize(fontSize);
    doc.setFont('helvetica', style);

    // Handle long text wrapping
    const maxWidth = pageWidth - (2 * margin);
    const lines = doc.splitTextToSize(text, maxWidth);

    for (let line of lines) {
      if (!checkPageBreak()) return false;
      doc.text(line, x, y);
      y += lineHeight;
    }
    return true;
  };

  // Title
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text('3D PRINTING SPEC REPORT', pageWidth / 2, y, { align: 'center' });
  y += 12;

  // Header info
  addText(`PRODUCT: ${product.name}`, margin, 12, 'bold');
  addText(`FILAMENT: ${filament.material} ${filament.color}, ${filament.spoolSize}g, R${filament.price}/spool`, margin, 10);
  addText(`GENERATED: ${currentReportData.generatedDate}`, margin, 10);
  y += 8;

  // Production Specs
  if (addText('A. PRODUCTION SPECS', margin, 14, 'bold')) {
    addText(`Filament Used: ${product.filamentUsed}g (${((product.filamentUsed / filament.spoolSize) * 100).toFixed(1)}% of spool)`, margin + 5, 10);
    addText(`Print Time: ${product.printTime}h`, margin + 5, 10);
    addText(`Layer Height: ${product.layerHeight}mm`, margin + 5, 10);
    addText(`Infill: ${product.infill}%`, margin + 5, 10);
    addText(`Support Required: ${product.supportRequired}`, margin + 5, 10);
    y += 5;
  }

  // Cost Breakdown
  if (addText('B. COST BREAKDOWN (Per Unit)', margin, 14, 'bold')) {
    addText(`Material (${filament.material}): R${baseCosts.materialCost.toFixed(2)}`, margin + 5, 10);
    addText(`Energy: R${product.energyCost.toFixed(2)}`, margin + 5, 10);
    addText(`Labor: R${product.laborCost.toFixed(2)}`, margin + 5, 10);
    addText(`Packaging: R${product.packagingCost.toFixed(2)}`, margin + 5, 10);
    addText(`Shipping (est.): R${product.shippingCost.toFixed(2)}`, margin + 5, 10);
    addText(`TOTAL PRODUCTION COST: R${baseCosts.totalCost.toFixed(2)}`, margin + 5, 11, 'bold');
    y += 5;
  }

  // Pricing Scenarios
  if (addText('C. PRICING SCENARIOS & MARGINS', margin, 14, 'bold')) {
    scenarios.forEach((s, i) => {
      if (currentPage >= maxPages) return;
      const label = i === 1 ? ' (RECOMMENDED)' : '';
      addText(`${s.name}${label}: R${s.price}`, margin + 5, 11, 'bold');
      addText(`  Gross Profit: R${s.grossProfit.toFixed(2)} | Margin: ${s.grossMarginPercent.toFixed(1)}%`, margin + 10, 9);
      addText(`  Net Profit: R${s.netProfit.toFixed(2)} | Margin: ${s.netMarginPercent.toFixed(1)}%`, margin + 10, 9);
      addText(`  Per Spool: ${s.unitsPerSpool} units, Profit: R${s.spoolNetProfit.toFixed(2)}`, margin + 10, 9);
      y += 3;
    });
    y += 5;
  }

  // Production Capacity
  if (addText('D. PRODUCTION CAPACITY & REVENUE', margin, 14, 'bold')) {
    // Per Spool
    addText('Per 1kg Spool:', margin + 5, 11, 'bold');
    addText(`Complete Units: ${production.perSpool.units} ${product.name.toLowerCase()}s`, margin + 10, 10);
    addText(`Print Time: ${production.perSpool.printTime} hours`, margin + 10, 10);
    addText(`Material Used: ${production.perSpool.materialUsed}g (${((production.perSpool.materialUsed / filament.spoolSize) * 100).toFixed(1)}% efficiency)`, margin + 10, 10);
    addText(`Revenue @ R${product.targetPrice}: R${production.perSpool.revenue.toFixed(2)}`, margin + 10, 10);
    addText(`Net Profit: R${production.perSpool.netProfit.toFixed(2)}`, margin + 10, 10, 'bold');
    y += 5;

    // Monthly
    if (currentPage < maxPages) {
      addText(`Monthly (at ${production.monthly.spools} spools/month):`, margin + 5, 11, 'bold');
      addText(`Units Produced: ${production.monthly.units} ${product.name.toLowerCase()}s`, margin + 10, 10);
      addText(`Revenue @ R${product.targetPrice}: R${production.monthly.revenue.toFixed(2)}`, margin + 10, 10);
      addText(`Material Cost: R${production.monthly.materialCost.toFixed(2)}`, margin + 10, 10);
      addText(`Gross Profit: R${production.monthly.grossProfit.toFixed(2)} | Margin: ${production.monthly.grossMarginPercent.toFixed(1)}%`, margin + 10, 10);
      addText(`Net Profit (est.): R${production.monthly.netProfit.toFixed(2)} | Margin: ${production.monthly.netMarginPercent.toFixed(1)}%`, margin + 10, 10, 'bold');
      y += 5;
    }

    // Annual
    if (currentPage < maxPages) {
      addText(`Annual (conservative ${production.monthly.spools} spools/month):`, margin + 5, 11, 'bold');
      addText(`Units Produced: ${production.annual.units} ${product.name.toLowerCase()}s`, margin + 10, 10);
      addText(`Revenue @ R${product.targetPrice}: R${production.annual.revenue.toFixed(2)}`, margin + 10, 10);
      addText(`Material Cost: R${production.annual.materialCost.toFixed(2)}`, margin + 10, 10);
      addText(`Gross Profit: R${production.annual.grossProfit.toFixed(2)} | Margin: ${production.annual.grossMarginPercent.toFixed(1)}%`, margin + 10, 10);
      addText(`Net Profit (est.): R${production.annual.netProfit.toFixed(2)} | Margin: ${production.annual.netMarginPercent.toFixed(1)}%`, margin + 10, 10, 'bold');
      y += 5;
    }
  }

  // Strategic Recommendations
  if (currentPage < maxPages && addText('E. STRATEGIC RECOMMENDATIONS', margin, 14, 'bold')) {
    addText(`✓ Recommended Selling Price: R${scenarios[1].price}–${scenarios[2].price}`, margin + 5, 10);
    addText(`✓ Primary Channel: Etsy + Personal website`, margin + 5, 10);
    addText(`✓ Scaling Strategy: Add 1 printer per ${production.perSpool.units * 10} units/month demand`, margin + 5, 10);
    addText(`✓ Design Differentiation: Customize (monograms, logos, colors)`, margin + 5, 10);
    addText(`✓ Competitive Advantages: ${baseCosts.grossMarginPercent.toFixed(0)}% gross margins, local production`, margin + 5, 10);
  }

  // Product Notes
  if (currentPage < maxPages && product.notes) {
    if (addText('F. PRODUCT NOTES', margin, 14, 'bold')) {
      addText(product.notes, margin + 5, 10);
    }
  }

  // Add page numbers
  const totalPages = Math.min(currentPage, maxPages);
  for (let i = 1; i <= totalPages; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    doc.text(`Page ${i} of ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
  }

  // Save PDF
  const filename = `3D_Print_Report_${product.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
  doc.save(filename);

  showToast('success', 'PDF Exported', `Report saved as ${filename}`);
}

// Save report to Firestore
async function saveReportToFirestore(reportData) {
  try {
    const reportToSave = {
      productName: reportData.product.name,
      productId: reportData.product.id,
      filamentName: `${reportData.filament.material} ${reportData.filament.color}`,
      filamentId: reportData.filament.id,
      monthlySpools: reportData.monthlySpools,
      netProfit: reportData.production.monthly.netProfit,
      revenue: reportData.production.monthly.revenue,
      generatedDate: reportData.generatedDate,
      timestamp: firebase.firestore.Timestamp.now()
    };

    if (typeof db !== 'undefined' && db) {
      await db.collection('reports').add(reportToSave);
      loadPastReports();
    } else {
      const reports = JSON.parse(localStorage.getItem('reports') || '[]');
      reports.unshift({ ...reportToSave, id: generateId() });
      if (reports.length > 20) reports.length = 20;
      localStorage.setItem('reports', JSON.stringify(reports));
      renderPastReports(reports);
    }
  } catch (error) {
    console.error('Error saving report:', error);
  }
}

// Load past reports
function loadPastReports() {
  if (typeof db !== 'undefined' && db) {
    db.collection('reports').orderBy('timestamp', 'desc').limit(20).get()
      .then(snapshot => {
        const reports = [];
        snapshot.forEach(doc => reports.push({ id: doc.id, ...doc.data() }));
        renderPastReports(reports);
      })
      .catch(() => {
        const reports = JSON.parse(localStorage.getItem('reports') || '[]');
        renderPastReports(reports);
      });
  } else {
    const reports = JSON.parse(localStorage.getItem('reports') || '[]');
    renderPastReports(reports);
  }
}

// Render past reports in 3-column grid
function renderPastReports(reports) {
  const container = document.getElementById('past-reports-list');
  if (!container) return;

  if (reports.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>No past reports yet</p></div>';
    return;
  }

  container.innerHTML = `
    <div class="grid grid-3">
      ${reports.map(report => `
        <div class="card">
          <div class="card-header">
            <div>
              <h4 class="card-title" style="font-size: 1rem;">${report.productName}</h4>
              <small style="color: var(--text-tertiary);">${report.filamentName}</small>
            </div>
            <button class="btn btn-danger btn-sm" onclick="deletePastReport('${report.id}')">
              <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
            </button>
          </div>
          <div style="padding: 0.5rem 0;">
            <table style="width: 100%; font-size: 0.85rem;">
              <tr><td style="color: var(--text-tertiary);">Monthly Revenue:</td><td style="text-align: right;"><strong>R${report.revenue.toFixed(2)}</strong></td></tr>
              <tr><td style="color: var(--text-tertiary);">Net Profit:</td><td style="text-align: right;"><strong style="color: var(--success);">R${report.netProfit.toFixed(2)}</strong></td></tr>
              <tr><td style="color: var(--text-tertiary);">Spools/Month:</td><td style="text-align: right;">${report.monthlySpools}</td></tr>
              <tr><td style="color: var(--text-tertiary);">Generated:</td><td style="text-align: right;">${report.generatedDate}</td></tr>
            </table>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

// Delete past report
async function deletePastReport(reportId) {
  if (!confirm('Delete this report?')) return;
  try {
    if (typeof db !== 'undefined' && db) {
      await db.collection('reports').doc(reportId).delete();
      showToast('success', 'Report Deleted', 'Past report removed');
      loadPastReports();
    } else {
      const reports = JSON.parse(localStorage.getItem('reports') || '[]');
      const filtered = reports.filter(r => r.id !== reportId);
      localStorage.setItem('reports', JSON.stringify(filtered));
      renderPastReports(filtered);
      showToast('success', 'Report Deleted', 'Past report removed');
    }
  } catch (error) {
    showToast('error', 'Delete Failed', 'Could not delete report');
  }
}

// Load past reports on page load
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => loadPastReports(), 1000);
});
